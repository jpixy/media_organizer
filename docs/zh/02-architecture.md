# 02 - 系统架构

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                  用户                                        │
│                                   │                                          │
│                                   ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                              CLI 入口                                  │  │
│  │                                                                        │  │
│  │   plan movies/tvshows <source> [--target]                             │  │
│  │   execute <plan.json>                                                  │  │
│  │   rollback <rollback.json>                                            │  │
│  │   index <path> | search <query> | export/import                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                   │                                          │
│                                   ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          Preflight Checker                             │  │
│  │                                                                        │  │
│  │   [x] ffprobe 可用    [x] Ollama 运行中    [x] TMDB API 可用          │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心处理流程                                     │
│                                                                              │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ Scanner  │───▶│ Metadata │───▶│  TMDB    │───▶│ Planner  │             │
│   │          │    │ Extractor│    │  Client  │    │          │             │
│   │ 目录扫描  │    │ 信息提取  │    │ 元数据查询 │    │ 计划生成  │             │
│   └──────────┘    └────┬─────┘    └──────────┘    └────┬─────┘             │
│                        │                               │                    │
│                        │ (按需)                        │                    │
│                        ▼                               ▼                    │
│                   ┌──────────┐                   ┌──────────┐              │
│                   │  Ollama  │                   │plan.json │              │
│                   │  AI解析   │                   │          │              │
│                   └──────────┘                   └────┬─────┘              │
│                                                       │                     │
│                                                       ▼                     │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐             │
│   │ rollback │◀───│   NFO    │◀───│  File    │◀───│ Executor │             │
│   │   .json  │    │ Generator│    │  Mover   │    │          │             │
│   │          │    │          │    │          │    │ 计划执行  │             │
│   └──────────┘    └──────────┘    └──────────┘    └──────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                               外部服务                                        │
│                                                                              │
│   ┌────────────────────┐    ┌────────────────────┐    ┌─────────────────┐  │
│   │   Ollama Service   │    │     TMDB API       │    │    ffprobe      │  │
│   │                    │    │                    │    │                 │  │
│   │   localhost:11434  │    │ api.themoviedb.org │    │  视频元数据提取  │  │
│   │   qwen2.5:7b       │    │                    │    │                 │  │
│   └────────────────────┘    └────────────────────┘    └─────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 模块结构

```
media_organizer/
├── src/
│   ├── main.rs                 # 程序入口
│   ├── lib.rs                  # 库入口
│   │
│   ├── cli/                    # 命令行接口
│   │   ├── mod.rs
│   │   ├── args.rs             # clap 参数定义
│   │   └── commands/           # 子命令实现
│   │       ├── plan.rs
│   │       ├── execute.rs
│   │       ├── rollback.rs
│   │       ├── index.rs
│   │       ├── search.rs
│   │       └── export_import.rs
│   │
│   ├── core/                   # 核心业务逻辑
│   │   ├── mod.rs
│   │   ├── scanner.rs          # 目录扫描
│   │   ├── parser.rs           # AI 文件名解析
│   │   ├── metadata.rs         # 元数据提取 (待实现)
│   │   ├── planner.rs          # 计划生成
│   │   ├── executor.rs         # 计划执行
│   │   ├── rollback.rs         # 回滚处理
│   │   └── indexer.rs          # 中央索引
│   │
│   ├── services/               # 外部服务客户端
│   │   ├── mod.rs
│   │   ├── ollama.rs           # Ollama API 客户端
│   │   ├── tmdb.rs             # TMDB API 客户端
│   │   └── ffprobe.rs          # ffprobe 调用封装
│   │
│   ├── models/                 # 数据模型
│   │   ├── mod.rs
│   │   ├── media.rs            # 媒体信息模型
│   │   ├── plan.rs             # 计划文件模型
│   │   ├── rollback.rs         # 回滚文件模型
│   │   ├── index.rs            # 索引模型
│   │   └── config.rs           # 配置模型
│   │
│   ├── generators/             # 生成器
│   │   ├── mod.rs
│   │   ├── nfo.rs              # NFO 文件生成
│   │   ├── filename.rs         # 文件名生成
│   │   └── folder.rs           # 文件夹名生成
│   │
│   └── preflight/              # 前置检查
│       ├── mod.rs
│       ├── ffprobe.rs
│       ├── ollama.rs
│       └── tmdb.rs
│
├── docs/                       # 文档
│   ├── zh/                     # 中文文档
│   └── en/                     # 英文文档
│
└── tests/                      # 测试
```

---

## 3. 数据流

### 3.1 Plan 阶段

```
源目录
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ Scanner: 递归扫描目录                                               │
│                                                                     │
│ 输入: 目录路径                                                      │
│ 输出: 视频文件列表 (路径, 大小, 父目录)                               │
│ 过滤: .mkv, .mp4, .avi, .mov, .wmv, .m4v, .ts, .flv, .webm, .rmvb  │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ Metadata Extractor: 提取候选元数据                                  │
│                                                                     │
│ 1. 检查文件名是否为已整理格式 → 提取 TMDB ID                          │
│ 2. 检查祖先目录是否为已整理格式 → 提取 TMDB ID                        │
│ 3. 从文件名/目录名提取: 标题、年份、季/集号                           │
│ 4. 必要时调用 AI 解析                                               │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ TMDB Client: 查询元数据                                             │
│                                                                     │
│ 快速路径: 有 TMDB ID → 直接查询详情                                   │
│ 搜索路径: 无 TMDB ID → 搜索匹配 → 验证 → 获取详情                     │
│                                                                     │
│ 搜索优先级:                                                         │
│   1. 中英文标题 + 年份 (交集匹配)                                    │
│   2. 英文标题 + 年份                                                 │
│   3. 中文标题 + 年份                                                 │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ ffprobe: 提取视频元数据                                             │
│                                                                     │
│ 输入: 视频文件路径                                                   │
│ 输出: 分辨率, 编码, 位深, 音频编码, 声道                              │
│ 并发: 多文件并行处理                                                 │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ Planner: 生成执行计划                                               │
│                                                                     │
│ - 生成目标文件夹名和文件名                                           │
│ - 规划操作列表 (mkdir, move, create, download)                      │
│ - 安全检查: 检测重复目标路径                                         │
│ - 输出 plan.json                                                    │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
plan.json
```

### 3.2 Execute 阶段

```
plan.json
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ Executor: 验证计划                                                  │
│                                                                     │
│ - 检查源文件存在性                                                   │
│ - 检查目标路径冲突                                                   │
│ - 初始化 rollback 记录                                               │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
┌────────────────────────────────────────────────────────────────────┐
│ 执行文件操作                                                        │
│                                                                     │
│ 1. mkdir: 创建目录结构                                               │
│ 2. move:  移动视频文件                                               │
│ 3. create: 生成 NFO 文件                                            │
│ 4. download: 下载海报 (并发)                                         │
│                                                                     │
│ 每步操作后立即记录到 rollback.json                                   │
└────────────────────────────────────────────────────────────────────┘
  │
  ▼
rollback.json + 整理后的目录结构
```

---

## 4. 关键数据结构

### 4.1 Plan 结构

```json
{
  "version": "1.0",
  "created_at": "2026-01-01T12:00:00Z",
  "media_type": "movies",
  "source_path": "/path/to/source",
  "target_path": "/path/to/target",
  
  "items": [
    {
      "id": "uuid-xxxx",
      "status": "pending",
      "source": {
        "path": "/path/to/source/movie.mp4",
        "filename": "movie.mp4",
        "size": 4500000000
      },
      "metadata": {
        "title": "阿凡达",
        "original_title": "Avatar",
        "year": 2009,
        "tmdb_id": 19995,
        "imdb_id": "tt0499549",
        "country_codes": ["US"]
      },
      "target": {
        "folder": "EN_English/[Avatar](2009)-tt0499549-tmdb19995",
        "filename": "[Avatar](2009)-tt0499549-tmdb19995-1080p-BluRay-x264-8bit-dts-5.1.mp4"
      },
      "operations": [
        {"type": "mkdir", "path": "..."},
        {"type": "move", "from": "...", "to": "..."},
        {"type": "create", "path": "...", "content_type": "nfo"},
        {"type": "download", "url": "...", "path": "..."}
      ]
    }
  ],
  
  "samples": [...],
  "unknown": [...]
}
```

### 4.2 Rollback 结构

```json
{
  "version": "1.0",
  "plan_id": "uuid-plan",
  "executed_at": "2026-01-01T12:00:00Z",
  
  "operations": [
    {
      "seq": 1,
      "op_type": "move",
      "from": "/source/movie.mp4",
      "to": "/target/EN_English/.../movie.mp4",
      "executed": true
    }
  ]
}
```

---

## 5. 外部服务接口

### 5.1 Ollama API

```
POST http://localhost:11434/api/generate
{
  "model": "qwen2.5:7b",
  "prompt": "解析视频文件名: xxx.mp4",
  "format": "json",
  "stream": false
}
```

### 5.2 TMDB API

```
# 搜索电影
GET https://api.themoviedb.org/3/search/movie?query=Avatar&year=2009

# 获取电影详情
GET https://api.themoviedb.org/3/movie/{id}?append_to_response=credits,release_dates

# 获取电视剧详情
GET https://api.themoviedb.org/3/tv/{id}?append_to_response=credits

# 获取系列信息
GET https://api.themoviedb.org/3/collection/{id}
```

### 5.3 ffprobe

```bash
ffprobe -v quiet -print_format json -show_streams -show_format /path/to/video.mp4
```

---

## 6. 并发与性能优化

| 操作 | 并发策略 |
|------|----------|
| ffprobe 调用 | 多文件并行 (使用 futures::join_all) |
| 海报下载 | 多文件并行 |
| TMDB API | 单文件顺序 (受 API 限流约束) |
| AI 解析 | 每目录首文件解析，后续文件复用 |
| TV Show 季缓存 | 每季查询一次，缓存全季集数信息 |

---

## 7. 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| AI 解析失败 | 标记为 unknown，跳过处理 |
| TMDB 无匹配 | 标记为 unknown，跳过处理 |
| TMDB 匹配不确定 | 跳过处理 (宁可遗漏) |
| ffprobe 失败 | 使用文件名解析的元数据 |
| 文件操作失败 | 中断执行，保留 rollback 记录 |
| 目标路径冲突 | Plan 阶段检测并报错 |


