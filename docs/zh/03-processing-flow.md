# 03 - 核心处理流程

## 1. 概述

本文档描述 Media Organizer 的核心处理流程，包括元数据提取、TMDB 匹配和文件处理逻辑。

---

## 2. 文件处理流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         文件处理入口                                  │
│                      process_video(file)                            │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    阶段 1: 文件类型判断                               │
│                                                                     │
│  ┌─────────────────┐                                                │
│  │ 是已整理格式?    │──Yes──▶ 提取 TMDB ID ──▶ 阶段 4 (直接查询)      │
│  │ [Title]-S01E01  │                                                │
│  │ [Title](Year)-  │                                                │
│  └────────┬────────┘                                                │
│           │ No                                                      │
│           ▼                                                         │
│  ┌─────────────────┐                                                │
│  │ 在已整理目录中?  │──Yes──▶ 从目录提取 TMDB ID ──▶ 阶段 4          │
│  │ (祖先目录有     │                                                │
│  │  tmdb 标识)     │                                                │
│  └────────┬────────┘                                                │
│           │ No                                                      │
│           ▼                                                         │
│       全新文件 ──────────────▶ 阶段 2 (完整解析流程)                  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    阶段 2: 信息收集 (仅全新文件)                       │
│                                                                     │
│  2.1 从文件名提取                                                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  extract_from_filename(filename) -> FilenameInfo            │   │
│  │    ├── 标题 (中文/英文)                                      │   │
│  │    ├── 年份                                                  │   │
│  │    ├── 季/集号 (TV Shows)                                    │   │
│  │    └── 技术信息 (分辨率、编码等)                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  2.2 目录类型判断与信息提取                                          │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  classify_directory(dir_name) -> DirectoryType              │   │
│  │    ├── TitleDirectory  (作品目录: 包含作品名)                │   │
│  │    ├── SeasonDirectory (季目录: Season 01, 第一季)           │   │
│  │    ├── QualityDirectory (质量目录: 4K, 1080P)               │   │
│  │    ├── CategoryDirectory (分类目录: 演员名/系列名/年份)      │   │
│  │    └── Unknown (无法判断)                                    │   │
│  │                                                              │   │
│  │  向上遍历，找到第一个 TitleDirectory                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  2.3 合并信息                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  merge_info(filename_info, dir_info) -> CandidateMetadata   │   │
│  │    优先级: 文件名信息 > 目录信息 (文件名更具体)               │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    阶段 3: AI 补充 (按需)                            │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  if candidate.needs_ai_parsing():                           │   │
│  │      # 当以下情况时需要 AI:                                  │   │
│  │      # - 没有中文标题也没有英文标题                          │   │
│  │      # - 标题看起来像是编码/技术信息                         │   │
│  │                                                              │   │
│  │      ai_result = parser.parse(filename + context)           │   │
│  │      candidate.merge_ai_result(ai_result)                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    阶段 4: TMDB 匹配                                 │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  4A: 如果有 TMDB ID (来自已整理格式)                         │   │
│  │      ├── 直接调用 get_movie_details(tmdb_id) 或             │   │
│  │      │            get_tv_details(tmdb_id)                   │   │
│  │      └── 快速获取最新信息，无需搜索                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  4B: 如果没有 TMDB ID (全新文件)                             │   │
│  │      ├── 使用候选元数据搜索                                  │   │
│  │      ├── 搜索优先级:                                         │   │
│  │      │   1. 中英文标题 + 年份 (最精确)                       │   │
│  │      │   2. 英文标题 + 年份                                  │   │
│  │      │   3. 中文标题 + 年份                                  │   │
│  │      │   4. 仅标题 (无年份)                                  │   │
│  │      └── 验证匹配质量，不确定则跳过                          │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    阶段 5: 验证与决策                                │
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  validate_match(tmdb_result, candidate) -> MatchQuality     │   │
│  │                                                              │   │
│  │  MatchQuality:                                               │   │
│  │    ├── Exact     (精确匹配: 标题+年份完全一致)               │   │
│  │    ├── High      (高置信: 标题相似且年份匹配)                │   │
│  │    ├── Medium    (中置信: 标题相似或年份接近)                │   │
│  │    ├── Low       (低置信: 仅部分匹配)                        │   │
│  │    └── NoMatch   (无匹配)                                    │   │
│  │                                                              │   │
│  │  决策规则:                                                    │   │
│  │    ├── Exact/High  -> 处理                                   │   │
│  │    ├── Medium      -> 根据配置决定 (默认跳过)                │   │
│  │    └── Low/NoMatch -> 跳过 (宁可遗漏，不能错误)              │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 目录类型分类

### 3.1 目录类型定义

| 类型 | 描述 | 示例 |
|------|------|------|
| **TitleDirectory** | 作品目录，包含作品名 | `吉尔莫·德尔·托罗 Guillermo (2022)` |
| **SeasonDirectory** | 季目录 | `Season 01`, `第一季`, `S01` |
| **QualityDirectory** | 质量/技术描述 | `4K`, `1080P`, `BluRay`, `内封字幕` |
| **CategoryDirectory** | 分类目录 | `周星驰`, `漫威电影`, `2024`, `韩剧` |
| **OrganizedDirectory** | 已整理目录 | `[罚罪2](2025)-tt36771056-tmdb296146` |

### 3.2 分类目录识别规则

```rust
fn is_category_directory(name: &str) -> bool {
    // 地区分类
    // 韩剧, 美剧, 日剧, 英剧, 国产剧, 港剧, 台剧
    // 韩国, 美国, 日本, 中国, 香港
    
    // 年份分类
    // 2024, 2024年, 2024年新番
    
    // 类型分类
    // 电影, 电视剧, 综艺, 动漫, 纪录片
    
    // 系列名
    // 漫威, DC, 星球大战, 哈利波特
}
```

### 3.3 作品目录识别规则

作品目录的典型格式：
- `中文标题 英文标题 (年份)`
- `中文标题 (年份)`
- `英文标题 (年份)`
- `中文标题.英文标题.年份`

---

## 4. 已整理格式识别

### 4.1 已整理文件名格式

**电影**：
```
[Title](Year)-ttIMDB-tmdbTMDB-resolution-format-codec-bitdepth-audio-channels.ext
```

正则：
```regex
^\[.+\]\(\d{4}\)-tt\d+-tmdb\d+-.+\.(mp4|mkv|avi)$
```

**电视剧**：
```
[ShowTitle]-SXXEXX-[EpisodeTitle]-resolution-format-codec-bitdepth-audio-channels.ext
```

正则：
```regex
^\[.+\]-S\d{1,2}E\d{1,3}-\[.+\]-.+\.(mp4|mkv|avi)$
```

### 4.2 已整理目录名格式

```
[Title](Year)-ttIMDB-tmdbTMDB
```

正则：
```regex
^\[.+\]\(\d{4}\)-tt\d+-tmdb(\d+)$
```

### 4.3 提取信息

从已整理格式中提取：
- TMDB ID
- IMDB ID
- 标题
- 年份
- 季号/集号 (电视剧)

---

## 5. TV Show 特殊处理

### 5.1 季缓存机制

对于同一目录下的多个文件，使用缓存减少 API 调用：

```
目录: [罚罪2](2025)-tmdb296146/Season 01/
  │
  ├── E01.mp4 ──▶ 查询 TMDB + 获取全季集数 ──▶ 缓存
  ├── E02.mp4 ──▶ 使用缓存
  ├── E03.mp4 ──▶ 使用缓存
  └── E04.mp4 ──▶ 使用缓存
```

### 5.2 集号提取

优先使用正则提取集号，AI 解析作为补充：

```rust
// 正则模式
S01E01, S1E1
E01, E1, EP01
第01集, 第1集
01.mp4, 1.mp4 (纯数字)
```

### 5.3 从目录提取季号

```rust
// 正则模式
Season 01, Season 1
S01, S1
第一季, 第1季
```

---

## 6. TMDB 匹配策略

### 6.1 搜索优先级

1. **中英文交集匹配** (最可靠)
   - 同时搜索中文和英文标题
   - 取两个结果的交集
   - 如果有交集，从中选择最佳匹配

2. **英文标题匹配**
   - 仅使用英文标题搜索
   - 选择最佳匹配

3. **中文标题匹配**
   - 仅使用中文标题搜索
   - 选择最佳匹配

### 6.2 最佳匹配选择

```rust
fn select_best_match(query: &str, results: &[SearchResult]) -> Option<SearchResult> {
    // 排除未来发行的作品
    // 计算标题相似度得分
    // 考虑投票数作为可信度指标
    // 精确匹配 > 包含匹配 > 相似匹配
}
```

### 6.3 匹配验证

验证标准：
- 标题相似度 > 0.7
- 年份匹配 (允许 ±1 年偏差)
- 国家信息一致 (如果可用)

---

## 7. 增量整理处理

### 7.1 场景：新增剧集

```
已整理目录:
[罚罪2](2025)-tt36771056-tmdb296146/
├── Season 01/
│   ├── [罚罪2]-S01E01-[第1集]-1080p.mp4   ✅ 已整理
│   ├── [罚罪2]-S01E02-[第2集]-1080p.mp4   ✅ 已整理
│   └── 罚罪2.E03.1080p.mp4                 🆕 新增
```

处理流程：
1. 识别新文件 `罚罪2.E03.1080p.mp4`
2. 检测其在已整理目录中
3. 从目录名提取 TMDB ID (296146)
4. 使用正则提取集号 (E03)
5. 直接查询 TMDB 获取第3集详情
6. 生成目标文件名

### 7.2 场景：重新整理

```
已整理文件:
[Avatar](2009)-tt0499549-tmdb19995-1080p.mp4
```

处理流程：
1. 识别文件名为已整理格式
2. 提取 TMDB ID (19995)
3. 直接查询 TMDB 获取最新详情
4. 使用新详情生成目标 (可能更新 NFO)

---

## 8. 性能优化

### 8.1 并行处理

| 操作 | 并行化 |
|------|--------|
| ffprobe 调用 | 使用 `futures::join_all` 并行 |
| 海报下载 | 使用 `futures::join_all` 并行 |
| TMDB API | 受限于 API 限流，顺序执行 |

### 8.2 缓存策略

| 缓存类型 | 作用域 | 内容 |
|----------|--------|------|
| TV Show 缓存 | 同一目录 | 剧集元数据 |
| 季集数缓存 | 同一剧集同一季 | 全季所有集的详情 |
| TMDB 搜索缓存 | 可选 | 搜索结果 (未实现) |

---

## 9. 错误处理与日志

### 9.1 错误分类

| 错误类型 | 处理方式 | 日志级别 |
|----------|----------|----------|
| AI 解析失败 | 跳过，标记为 unknown | WARN |
| TMDB 无匹配 | 跳过，标记为 unknown | WARN |
| TMDB 不确定匹配 | 跳过，标记为 unknown | INFO |
| ffprobe 失败 | 使用文件名元数据 | WARN |
| 网络错误 | 重试或中断 | ERROR |

### 9.2 日志示例

```
[SCAN] Found 276 video files in /path/to/source
[AI] Parsing: movie.mp4 (CPU inference may take 1-3 min)
[TMDB] Found match: Avatar (2009) - tmdb19995
[ORGANIZED] Re-indexing: [罚罪2]-S01E01-... (using tmdb296146)
[WARN] Skipped: unknown.mp4 - No TMDB match
[OK] Plan generated: 268 items, 8 unknown
```

---

## 10. 已实现的优化

### 10.1 统一元数据提取 (已实现)

`CandidateMetadata` 结构已在 `src/core/metadata.rs` 中实现：

```rust
pub struct CandidateMetadata {
    pub chinese_title: Option<String>,
    pub english_title: Option<String>,
    pub year: Option<u16>,
    pub season: Option<u32>,
    pub episode: Option<u32>,
    pub tmdb_id: Option<u64>,
    pub imdb_id: Option<String>,
    pub source: Option<MetadataSource>,
    pub confidence: f32,
    // ... 其他字段
}
```

### 10.2 目录类型分类 (已实现)

智能目录分类已在 `src/core/metadata.rs` 中实现：

```rust
pub enum DirectoryType {
    TitleDirectory(TitleInfo),
    SeasonDirectory(u32),
    QualityDirectory,
    CategoryDirectory,
    OrganizedDirectory(OrganizedInfo),
    Unknown,
}
```

### 10.3 已组织文件快速处理 (已实现)

对于已组织格式的文件，系统会：

1. **跳过 AI 解析** - 直接从文件名/目录名提取 TMDB ID
2. **使用缓存** - 同一剧集的多个文件共享元数据缓存
3. **直接查询 TMDB** - 使用 ID 直接获取详情，无需搜索

**性能提升**：
- 40个已组织文件：~90秒 -> ~3秒 (约30倍提升)
- 避免了冗余的 AI 调用和 TMDB 搜索

### 10.4 TMDB ID 提取优化 (已实现)

当文件名不包含 TMDB ID 时，系统会从父文件夹提取：

```
Movies_organized/EN_English/[Avatar](2009)-tt0499549-tmdb19995/
  └── [Avatar](2009)-1080p-WEB-DL.mp4  <- 从父文件夹获取 tmdb19995
```

### 10.5 父目录 ID 回退查找 (已实现)

当季度目录的 IMDB ID 无法被 TMDB 识别时（如季度特定的 ID），系统会自动向上查找父目录获取剧集的主 ID：

```
L_流人.Slow Horses.tt5875444/          <- 主剧集 IMDB ID
  ├── S02.tt13660696/                  <- 季度 ID (TMDB 不认识)
  │     └── episode.mp4                <- 自动使用 tt5875444
  └── S03.tt20778346/
        └── episode.mp4                <- 自动使用 tt5875444
```

**实现**：
- `try_parent_directory_id_lookup()` 在 `planner.rs` 中
- `extract_ids_from_path_starting_at()` 在 `metadata.rs` 中

### 10.6 CJK 父目录上下文 (已实现)

当父目录包含 CJK 字符（中文/日文/韩文）但文件名使用罗马字/拉丁字符时，父目录名会被添加到 AI 解析上下文：

```
逃避虽可耻但有用/                           <- 父目录有 CJK 标题
  └── NIGEHAJI.E01.720p.FIX字幕侠/         <- 单集文件夹 (跳过)
        └── [V2]NIGEHAJI.E01.720p.mkv      <- 罗马字文件名

AI 输入变为: "逃避虽可耻但有用 - [V2]NIGEHAJI.E01.720p.mkv"
```

这解决了以下情况：
- **NIGEHAJI** (逃げ恥) - 日语罗马字缩写
- 其他文件名使用罗马字但目录使用正确 CJK 标题的情况

**检测逻辑**：
1. 检查父目录是否包含 CJK 字符
2. 检查文件名是否主要是拉丁字符
3. 如果两个条件都满足，将父目录名加入 AI 上下文

