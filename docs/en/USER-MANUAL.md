# Media Organizer User Manual

## Table of Contents

1. [Overview](#1-overview)
2. [Installation & Configuration](#2-installation--configuration)
3. [Command Reference](#3-command-reference)
4. [Workflow](#4-workflow)
5. [Central Index System](#5-central-index-system)
6. [Search Features](#6-search-features)
7. [Backup & Recovery](#7-backup--recovery)
8. [FAQ](#8-faq)

---

## 1. Overview

**Media Organizer** is a Rust-based CLI tool for automatically organizing video files (movies and TV shows).

### Core Features

| Feature | Description |
|---------|-------------|
| **AI Filename Parsing** | Uses Ollama local AI to parse mixed Chinese/English filenames |
| **TMDB Metadata** | Automatically matches TMDB database for detailed info |
| **Standardized Naming** | Renames files and directories in unified format |
| **NFO Generation** | Generates Kodi/Emby/Jellyfin compatible NFO files |
| **Poster Download** | Automatically downloads movie/show posters |
| **Central Index** | Cross-disk offline search, supporting both movies and TV shows |
| **Export/Import** | Configuration backup and migration |

### Supported Media Types

- **movies** - Movies
- **tvshows** - TV Shows

---

## 2. Installation & Configuration

### 2.1 System Requirements

- Linux operating system
- 8GB+ RAM (16GB+ recommended)
- Rust toolchain (for compilation)

### 2.2 Dependencies

| Service | Purpose | Installation |
|---------|---------|--------------|
| **Ollama** | AI filename parsing | `curl -fsSL https://ollama.ai/install.sh \| sh` |
| **qwen2.5:7b** | AI model | `ollama pull qwen2.5:7b` |
| **ffprobe** | Video info extraction | `sudo apt install ffmpeg` |
| **TMDB API** | Metadata fetching | Register at themoviedb.org |

### 2.3 Environment Variables

```bash
# Required
export TMDB_API_KEY="your_api_key"

# Optional (have defaults)
export OLLAMA_BASE_URL="http://localhost:11434"  # default
export OLLAMA_MODEL="qwen2.5:7b"                  # default
```

### 2.4 Build & Install

```bash
git clone https://github.com/jpixy/media_organizer.git
cd media_organizer
cargo build --release

# Optional: add to PATH
sudo cp target/release/media-organizer /usr/local/bin/
```

---

## 3. Command Reference

### 3.1 Global Options

```bash
media-organizer [OPTIONS] <COMMAND>

Options:
  -v, --verbose         Verbose output
      --skip-preflight  Skip preflight checks
  -h, --help            Show help
  -V, --version         Show version
```

### 3.2 plan - Generate Organization Plan

Generates a file organization plan without moving files.

```bash
# Movies
media-organizer plan movies <source> [OPTIONS]

# TV Shows
media-organizer plan tvshows <source> [OPTIONS]

Options:
  -t, --target <target>  Target directory (default: source_organized)
      --dry-run          Check only, don't generate plan
```

**Examples:**

```bash
# Organize movies
media-organizer plan movies /mnt/downloads/movies -t /mnt/library/movies

# Organize TV shows
media-organizer plan tvshows /mnt/downloads/tvshows -t /mnt/library/tvshows
```

### 3.3 execute - Execute Plan

Executes a plan file generated by the plan command.

```bash
media-organizer execute <plan.json> [OPTIONS]

Options:
  -o, --output <path>  Rollback file output path
```

### 3.4 rollback - Rollback Operations

Rolls back previous execution, moving files back to original locations.

```bash
media-organizer rollback <rollback.json> [OPTIONS]

Options:
  --dry-run  Preview rollback without executing
```

### 3.5 index - Index Management

Manages the central media index.

```bash
media-organizer index <SUBCOMMAND>

Subcommands:
  scan         Scan directory to build index
  stats        Show collection statistics
  list         List contents of specific disk
  verify       Verify index against files
  remove       Remove disk from index
  duplicates   Find duplicates
  collections  List movie collections
```

#### scan - Scan Directory

```bash
media-organizer index scan <path> [OPTIONS]

Options:
  --media-type <type>    movies or tvshows (default: movies)
  --disk-label <label>   Disk label (auto-detected)
  --force                Force re-index
```

**Examples:**

```bash
# Index movies
media-organizer index scan /mnt/library/movies --media-type movies --disk-label MyDisk

# Index TV shows (same disk)
media-organizer index scan /mnt/library/tvshows --media-type tvshows --disk-label MyDisk

# Single disk can contain both movies and TV shows with same disk-label
```

#### stats - Show Statistics

```bash
media-organizer index stats
```

**Note:** By Language and By Decade statistics include both movies and TV shows.

### 3.6 search - Search

Search the media collection. **Searches both movies and TV shows simultaneously.**

```bash
media-organizer search [OPTIONS]

Options:
  -t, --title <title>        Search by title
  -a, --actor <actor>        Search by actor
  -d, --director <director>  Search by director (movies only)
  -c, --collection <series>  Search by collection (movies only)
  -y, --year <year>          Search by year (supports ranges: 2020-2024)
  -g, --genre <genre>        Search by genre
  --language <code>          Search by language (en, zh, ja, ko, etc.)
  --show-status              Show online/offline status
  --format <format>          Output: table, simple, json
```

**Examples:**

```bash
# Search by title (searches both movies and TV shows)
media-organizer search --title "Inception"

# Search by actor
media-organizer search --actor "Leonardo DiCaprio"

# Search by year range
media-organizer search --year 2020-2024

# Combined search
media-organizer search --actor "Leonardo" --year 2010-2020

# JSON output
media-organizer search --title "Black Mirror" --format json
```

### 3.7 export - Export

Export configuration and indexes for backup.

```bash
media-organizer export [OUTPUT] [OPTIONS]

Options:
  --include-secrets    Include sensitive data (API keys)
  --only <type>        Only export: indexes, config, sessions
  --exclude <type>     Exclude: indexes, config, sessions
  --disk <label>       Only export specific disk's index
  --auto-name          Auto-generate filename with timestamp
```

### 3.8 import - Import

Import configuration and indexes from backup.

```bash
media-organizer import <backup_file> [OPTIONS]

Options:
  --dry-run       Preview import content
  --only <type>   Only import: indexes, config, sessions
  --merge         Merge (don't overwrite existing data)
  --force         Force overwrite
  --backup-first  Backup existing config before import
```

---

## 4. Workflow

### 4.1 Complete Workflow

```
┌─────────────────┐
│  Source Videos  │
│ (messy naming)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  plan command   │  ← AI parsing + TMDB matching
│ generate plan   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  review plan    │  ← manual review
│   (optional)    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│execute command  │  ← move files + generate NFO + download posters
│  execute plan   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  index scan     │  ← build central index
│  build index    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│    search       │  ← cross-disk search
│  search media   │
└─────────────────┘
```

---

## 5. Central Index System

### 5.1 Design Philosophy

- **Cross-disk search**: Search even when disks are unmounted
- **Unified management**: One disk can contain both movies and TV shows
- **Offline browsing**: View collection without mounting disks

### 5.2 Storage Structure

```
~/.config/media_organizer/
├── central_index.json          # Main index
├── central_index.json.backup   # Auto backup
└── disk_indexes/
    ├── JMedia_M01.json
    └── JMedia_M05.json
```

### 5.3 Composite Storage

A single disk-label can store multiple media types:

```bash
# Same disk, different media types
media-organizer index scan /mnt/disk/movies --media-type movies --disk-label MyDisk
media-organizer index scan /mnt/disk/tvshows --media-type tvshows --disk-label MyDisk
```

---

## 6. Search Features

### 6.1 Search Scope

| Criteria | Movies | TV Shows |
|----------|--------|----------|
| --title | ✅ | ✅ |
| --actor | ✅ | ✅ |
| --director | ✅ | ❌ (uses creators) |
| --collection | ✅ | ❌ |
| --year | ✅ | ✅ |
| --genre | ✅ | ✅ |
| --language | ✅ | ✅ |

### 6.2 Output Formats

```bash
# Table format (default)
media-organizer search --title "Black Mirror"

# Simple format
media-organizer search --title "Black Mirror" --format simple

# JSON format (for scripting)
media-organizer search --title "Black Mirror" --format json
```

---

## 7. Backup & Recovery

### 7.1 Recommended Backup Strategy

```bash
# Weekly full backup
media-organizer export --auto-name

# Index only (more frequent)
media-organizer export --only indexes --auto-name
```

### 7.2 Recovery Process

```bash
# 1. Preview backup content
media-organizer import backup.zip --dry-run

# 2. Backup current config and import
media-organizer import backup.zip --backup-first --force
```

---

## 8. FAQ

### Q: How to handle files that fail AI parsing?

A: Check the "Unknown Files" list in plan output. Options:
1. Manually rename files and re-run plan
2. Ensure Ollama service is running properly

### Q: How to update index for organized files?

A: Use `--force` to re-scan:
```bash
media-organizer index scan /path --force
```

### Q: Search only shows movies, no TV shows?

A: Ensure TV shows are also indexed:
```bash
media-organizer index scan /path/to/tvshows --media-type tvshows
```

### Q: How to see which disks are online?

A: Use `--show-status` option:
```bash
media-organizer search --title "test" --show-status
media-organizer index stats
```

---

## Appendix

### A. Country Codes

| Code | Country |
|------|---------|
| US | United States |
| CN | China |
| KR | South Korea |
| JP | Japan |
| GB | United Kingdom |
| FR | France |
| DE | Germany |
| TW | Taiwan |
| HK | Hong Kong |

### B. Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| TMDB_API_KEY | TMDB API key | (required) |
| OLLAMA_BASE_URL | Ollama service URL | http://localhost:11434 |
| OLLAMA_MODEL | AI model name | qwen2.5:7b |

