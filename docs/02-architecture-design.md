# 架构设计

本文档描述 Media Organizer 的系统架构、模块划分、数据流和实现思路。

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用户                                        │
│                               │                                          │
│                               ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                         CLI 入口                                 │    │
│  │                                                                  │    │
│  │   media-organizer plan movies <source> [--target <path>]        │    │
│  │   media-organizer plan tvshows <source> [--target <path>]       │    │
│  │   media-organizer execute <plan.json>                           │    │
│  │   media-organizer rollback <rollback.json>                      │    │
│  │   media-organizer sessions list|show <id>                       │    │
│  │   media-organizer verify <path>                                 │    │
│  └──────────────────────────────┬──────────────────────────────────┘    │
│                                 │                                        │
│                                 ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                      Preflight Checker                           │    │
│  │                                                                  │    │
│  │   ✓ ffprobe 安装检查                                             │    │
│  │   ✓ Ollama 服务检查                                              │    │
│  │   ✓ TMDB API 连通性检查                                          │    │
│  └──────────────────────────────┬──────────────────────────────────┘    │
│                                 │                                        │
│                                 ▼                                        │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                           核心处理流程                                    │
│                                                                          │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│   │  Scanner │───▶│  Parser  │───▶│  TMDB    │───▶│  Planner │          │
│   │          │    │          │    │  Client  │    │          │          │
│   │ 目录扫描  │    │ 文件名解析│    │ 元数据查询│    │ 计划生成  │          │
│   └──────────┘    └────┬─────┘    └──────────┘    └────┬─────┘          │
│                        │                               │                 │
│                        │ HTTP                          │                 │
│                        ▼                               ▼                 │
│                   ┌──────────┐                   ┌──────────┐           │
│                   │  Ollama  │                   │plan.json │           │
│                   │  Service │                   │          │           │
│                   └──────────┘                   └────┬─────┘           │
│                                                       │                  │
│                                                       ▼                  │
│   ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐          │
│   │ rollback │◀───│  NFO     │◀───│  File    │◀───│ Executor │          │
│   │   .json  │    │ Generator│    │  Mover   │    │          │          │
│   │          │    │          │    │          │    │ 计划执行  │          │
│   └──────────┘    └──────────┘    └──────────┘    └──────────┘          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                            外部服务                                       │
│                                                                          │
│   ┌────────────────────┐          ┌────────────────────┐                │
│   │   local-ai-starter │          │     TMDB API       │                │
│   │                    │          │                    │                │
│   │   Ollama REST API  │          │  api.themoviedb.org│                │
│   │   localhost:11434  │          │                    │                │
│   └────────────────────┘          └────────────────────┘                │
│                                                                          │
│   ┌────────────────────┐                                                │
│   │      ffprobe       │                                                │
│   │                    │                                                │
│   │   视频元数据提取    │                                                │
│   └────────────────────┘                                                │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## CLI 命令结构

### 命令层级

```
media-organizer
│
├── plan                              # 生成执行计划
│   ├── movies <source>               # 处理电影
│   │   └── [--target <path>]         #   指定目标目录
│   └── tvshows <source>              # 处理电视剧
│       └── [--target <path>]         #   指定目标目录
│
├── execute <plan.json>               # 执行计划（类型从 JSON 读取）
│
├── rollback <rollback.json>          # 回滚操作（类型从 JSON 读取）
│
├── sessions                          # 会话管理
│   ├── list                          # 列出历史会话
│   └── show <session-id>             # 显示会话详情
│
└── verify <path>                     # 视频完整性校验
```

### 类型区分设计

| 命令 | 是否需要指定类型 | 说明 |
|------|-----------------|------|
| plan | ✅ 需要 | 位置参数 `movies` 或 `tvshows` |
| execute | ❌ 不需要 | 从 plan.json 中读取 `media_type` |
| rollback | ❌ 不需要 | 从 rollback.json 中读取 `media_type` |
| sessions | ❌ 不需要 | 与媒体类型无关 |
| verify | ❌ 不需要 | 通用视频校验 |

### 完整命令示例

```bash
# ========== Plan 阶段 ==========
# 电影：扫描源目录，生成执行计划
media-organizer plan movies /mnt/downloads/movies --target /mnt/media/movies
# 输出: plan.json

# 电视剧：扫描源目录，生成执行计划
media-organizer plan tvshows /mnt/downloads/shows --target /mnt/media/tvshows
# 输出: plan.json

# ========== 用户审核 plan.json ==========
# 可手动编辑 plan.json 修正 AI 识别错误

# ========== Execute 阶段 ==========
# 执行计划，生成回滚文件
media-organizer execute ./plan.json
# 输出: rollback.json

# ========== Rollback 阶段（可选）==========
# 如果对结果不满意，回滚到原始状态
media-organizer rollback ./rollback.json

# ========== 会话管理 ==========
# 列出所有历史会话
media-organizer sessions list

# 查看特定会话详情
media-organizer sessions show 2024-12-24_abc123

# ========== 视频校验 ==========
# 校验视频文件完整性
media-organizer verify /mnt/media/movies
```

---

## 模块划分

### 核心模块

```
media_organizer/
├── cli/                    # 命令行接口
│   ├── commands/           # 子命令实现
│   │   ├── plan            # plan 命令
│   │   ├── execute         # execute 命令
│   │   ├── rollback        # rollback 命令
│   │   ├── sessions        # sessions 命令
│   │   └── verify          # verify 命令
│   └── args                # 参数解析
│
├── core/                   # 核心业务逻辑
│   ├── scanner             # 目录扫描
│   ├── parser              # 文件名解析
│   ├── planner             # 计划生成
│   ├── executor            # 计划执行
│   └── rollback            # 回滚处理
│
├── services/               # 外部服务客户端
│   ├── ollama              # Ollama API 客户端
│   ├── tmdb                # TMDB API 客户端
│   └── ffprobe             # ffprobe 调用封装
│
├── models/                 # 数据模型
│   ├── media               # 媒体信息模型
│   ├── plan                # 计划文件模型
│   ├── rollback            # 回滚文件模型
│   └── config              # 配置模型
│
├── generators/             # 生成器
│   ├── nfo                 # NFO 文件生成
│   ├── filename            # 文件名生成
│   └── folder              # 文件夹名生成
│
├── utils/                  # 工具函数
│   ├── fs                  # 文件系统操作
│   ├── hash                # 校验和计算
│   └── chinese             # 中文繁简体处理
│
└── preflight/              # 前置检查
    ├── ffprobe_check
    ├── ollama_check
    └── tmdb_check
```

---

## 数据流

### Plan 阶段

```
┌─────────────────────────────────────────────────────────────────┐
│                         Plan 数据流                              │
│                                                                  │
│  源目录                                                          │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Scanner: 递归扫描目录                                      │   │
│  │                                                           │   │
│  │ 输入: 目录路径                                             │   │
│  │ 输出: 视频文件列表 (路径, 大小, 修改时间)                    │   │
│  │ 过滤: 视频扩展名 (.mkv, .mp4, .avi, .mov, .wmv, ...)      │   │
│  │ 识别: Sample 文件夹和文件                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Parser: 调用 Ollama 解析文件名                             │   │
│  │                                                           │   │
│  │ 输入: 文件名                                               │   │
│  │ 输出: 标题 (原始/中文), 年份, 置信度                         │   │
│  │ 失败: 标记为 unknown                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ TMDB Client: 查询电影/剧集信息                             │   │
│  │                                                           │   │
│  │ 输入: 标题, 年份                                           │   │
│  │ 输出: TMDB ID, IMDB ID, 原标题, 本地化标题, 简介, 演职员    │   │
│  │ 失败: 标记为 unknown                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ ffprobe: 提取视频元数据                                    │   │
│  │                                                           │   │
│  │ 输入: 视频文件路径                                         │   │
│  │ 输出: 分辨率, 编码, 位深, 音频编码, 声道                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Planner: 生成执行计划                                      │   │
│  │                                                           │   │
│  │ 汇总所有信息                                               │   │
│  │ 生成目标文件夹名和文件名                                    │   │
│  │ 规划操作列表 (mkdir, move, create, download)               │   │
│  │ 输出 plan.json                                            │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  plan.json                                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Execute 阶段

```
┌─────────────────────────────────────────────────────────────────┐
│                       Execute 数据流                             │
│                                                                  │
│  plan.json                                                       │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Executor: 读取并验证计划                                   │   │
│  │                                                           │   │
│  │ 检查源文件是否存在                                         │   │
│  │ 检查目标路径是否冲突                                        │   │
│  │ 初始化 rollback 记录                                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ File Mover: 执行文件操作                                   │   │
│  │                                                           │   │
│  │ 按顺序执行: mkdir → move → 记录到 rollback                 │   │
│  │ 每步操作后立即记录，确保可回滚                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ NFO Generator: 生成 NFO 文件                               │   │
│  │                                                           │   │
│  │ 使用 Kodi 兼容格式                                         │   │
│  │ 包含: 标题, 简介, 年份, 导演, 演员, 评分                     │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Poster Downloader: 下载海报                                │   │
│  │                                                           │   │
│  │ 从 TMDB 下载 1-3 张海报                                    │   │
│  │ 保存为 poster.jpg, fanart.jpg 等                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  rollback.json + 整理后的目录结构                                 │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Rollback 阶段

```
┌─────────────────────────────────────────────────────────────────┐
│                       Rollback 数据流                            │
│                                                                  │
│  rollback.json                                                   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ Rollback Handler: 解析回滚计划                             │   │
│  │                                                           │   │
│  │ 逆序读取操作列表                                           │   │
│  │ 验证文件完整性 (checksum)                                  │   │
│  │ 检测冲突 (文件被修改/删除)                                  │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │ 执行逆向操作                                               │   │
│  │                                                           │   │
│  │ delete (NFO, 海报) → move (视频文件) → rmdir (空目录)       │   │
│  └──────────────────────────────────────────────────────────┘   │
│    │                                                             │
│    ▼                                                             │
│  恢复后的原始目录结构                                             │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 文件结构设计

### 项目目录结构

```
media_organizer/
├── Cargo.toml              # 项目配置和依赖
├── Cargo.lock
├── README.md
├── LICENSE
│
├── src/
│   ├── main.rs             # 程序入口
│   ├── lib.rs              # 库入口
│   │
│   ├── cli/
│   │   ├── mod.rs
│   │   ├── args.rs         # clap 参数定义
│   │   └── commands/
│   │       ├── mod.rs
│   │       ├── plan.rs
│   │       ├── execute.rs
│   │       ├── rollback.rs
│   │       ├── sessions.rs
│   │       └── verify.rs
│   │
│   ├── core/
│   │   ├── mod.rs
│   │   ├── scanner.rs
│   │   ├── parser.rs
│   │   ├── planner.rs
│   │   ├── executor.rs
│   │   └── rollback.rs
│   │
│   ├── services/
│   │   ├── mod.rs
│   │   ├── ollama.rs
│   │   ├── tmdb.rs
│   │   └── ffprobe.rs
│   │
│   ├── models/
│   │   ├── mod.rs
│   │   ├── media.rs
│   │   ├── plan.rs
│   │   ├── rollback.rs
│   │   └── config.rs
│   │
│   ├── generators/
│   │   ├── mod.rs
│   │   ├── nfo.rs
│   │   ├── filename.rs
│   │   └── folder.rs
│   │
│   ├── utils/
│   │   ├── mod.rs
│   │   ├── fs.rs
│   │   ├── hash.rs
│   │   └── chinese.rs
│   │
│   └── preflight/
│       ├── mod.rs
│       ├── ffprobe.rs
│       ├── ollama.rs
│       └── tmdb.rs
│
├── tests/                  # 集成测试
│   ├── plan_test.rs
│   ├── execute_test.rs
│   └── fixtures/           # 测试数据
│
└── docs/                   # 文档
    ├── 01-design-preparation.md
    └── 02-architecture-design.md
```

### 运行时目录结构

```
~/.config/media_organizer/
├── config.toml             # 用户配置
└── sessions/               # 历史会话记录
    ├── 2024-12-24_abc123/
    │   ├── plan.json
    │   └── rollback.json
    └── 2024-12-25_def456/
        ├── plan.json
        └── rollback.json
```

### 整理后的目录结构示例

**电影：**
```
/mnt/media/movies/
├── [Avatar]-[阿凡达](2009)-tt0499549-tmdb19995/
│   ├── [Avatar]-[阿凡达](2009)-2160p-BluRay-x265-10bit-TrueHD-7.1.mkv
│   ├── movie.nfo
│   ├── poster.jpg
│   ├── fanart.jpg
│   └── Sample/
│       └── avatar_sample.mkv
│
├── [The Matrix]-[黑客帝国](1999)-tt0133093-tmdb603/
│   └── ...
│
└── unknown/                # 无法识别的文件
    ├── some_random_file.mkv
    └── another_file.avi
```

**电视剧：**
```
/mnt/media/tvshows/
├── [Breaking Bad]-[绝命毒师]-tt0903747-tmdb1396/
│   ├── tvshow.nfo
│   ├── poster.jpg
│   ├── S01.2008/
│   │   ├── [Breaking Bad]-S01E01-[Pilot]-[试播集]-BluRay-x264-8bit-AC3-5.1.mkv
│   │   ├── [Breaking Bad]-S01E01-[Pilot]-[试播集].nfo
│   │   └── ...
│   ├── S02.2009/
│   │   └── ...
│   └── unknown/
│       └── ...
│
└── unknown/
    └── ...
```

---

## 实现思路

### 阶段一：基础框架

1. **搭建项目骨架**
   - 初始化 Cargo 项目
   - 配置依赖（clap, tokio, reqwest, serde 等）
   - 建立模块目录结构

2. **实现前置检查**
   - ffprobe 检查
   - Ollama 连通性检查
   - TMDB API 检查

3. **实现目录扫描**
   - 递归遍历目录
   - 过滤视频文件
   - 识别 Sample 文件夹

### 阶段二：核心功能

4. **实现文件名解析**
   - 构造 Prompt 模板
   - 调用 Ollama API
   - 解析返回结果
   - 处理解析失败情况

5. **实现 TMDB 客户端**
   - 电影搜索 API
   - 电视剧搜索 API
   - 详情查询 API
   - 海报 URL 获取

6. **实现 ffprobe 调用**
   - 子进程调用
   - JSON 输出解析
   - 提取所需字段

7. **实现计划生成**
   - 汇总所有信息
   - 生成命名
   - 规划操作列表
   - 输出 plan.json

### 阶段三：执行与生成

8. **实现计划执行**
   - 读取 plan.json
   - 执行文件操作
   - 生成 rollback.json

9. **实现 NFO 生成**
   - Kodi 兼容的 XML 格式
   - 电影 NFO
   - 电视剧 NFO
   - 剧集 NFO

10. **实现海报下载**
    - 从 TMDB 下载图片
    - 保存到目标目录

### 阶段四：完善

11. **实现回滚功能**
    - 读取 rollback.json
    - 逆向执行操作
    - 冲突处理

12. **实现会话管理**
    - sessions list
    - sessions show
    - 历史清理

13. **实现视频校验**
    - 可选的完整性检查
    - 使用 ffprobe 验证

---

## 注意要点

### 文件名解析

- **Prompt 设计至关重要**：需要反复调优，确保对中英文混合文件名的解析准确率
- **置信度阈值**：设定合理的阈值，低于阈值的归入 unknown
- **批量请求优化**：考虑批量发送请求减少 Ollama 调用次数

### 中文处理

- **繁简体统一**：使用繁简转换库（如 opencc 的 Rust 绑定）判断是否为同一标题
- **中文电影判断**：根据 TMDB 返回的 `original_language` 字段判断

### 文件操作安全

- **原子性**：每步操作后立即记录到 rollback.json，确保中断后可恢复
- **冲突检测**：执行前检查目标路径是否已存在
- **权限检查**：确保对源和目标目录有读写权限

### 幂等性

- **唯一标识**：使用 TMDB ID 作为唯一标识
- **已处理检测**：检查目标是否已存在相同 TMDB ID 的文件夹
- **增量处理**：只处理新增或变更的文件

### 性能优化

- **并发扫描**：目录扫描可并发执行
- **请求限流**：TMDB API 有速率限制，需要适当控制
- **Ollama 请求**：根据本地 GPU 能力调整并发数

### 错误处理

- **优雅降级**：单个文件失败不影响其他文件处理
- **详细日志**：记录每个操作的结果，便于排查问题
- **断点续传**：支持从中断处继续执行

### 用户体验

- **进度显示**：显示处理进度和预计剩余时间
- **彩色输出**：使用颜色区分成功、警告、错误
- **dry-run 模式**：默认预览，用户确认后执行

---

## 依赖清单

| 依赖 | 用途 |
|------|------|
| clap | 命令行参数解析 |
| tokio | 异步运行时 |
| reqwest | HTTP 客户端 |
| serde / serde_json | JSON 序列化 |
| walkdir | 目录遍历 |
| indicatif | 进度条 |
| colored | 彩色输出 |
| sha2 | 校验和计算 |
| uuid | 会话 ID 生成 |
| chrono | 时间处理 |
| toml | 配置文件解析 |
| thiserror | 错误处理 |
| tracing | 日志记录 |

---

## 后续扩展

以下功能不在初期版本范围内，但架构设计时需要预留扩展空间：

- 支持更多视频格式
- 支持其他元数据源（如 IMDB、豆瓣）
- 支持字幕文件关联
- 支持多语言 NFO
- Web UI（如果未来需要）

